<script>

    function doGet() {
        return HtmlService
            .createHtmlOutputFromFile('Index')
            .setTitle('Panel de An√°lisis de Anotaciones');
            //.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); // para embeber en Google Sites
    }
</script>


<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Panel de An√°lisis de Anotaciones Estudiantiles</title>

    <!-- Estilos/DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <!-- Librer√≠as (defer respeta orden) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.1rem;
            margin-bottom: 8px;
            font-weight: 800;
        }

        .upload-section {
            padding: 22px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .uploader {
            display: grid;
            gap: 12px;
            justify-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #007bff;
            color: #fff;
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, .3);
            transition: .2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            background: #0056b3;
            box-shadow: 0 6px 20px rgba(0, 123, 255, .4);
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed;
        }

        input[type=file] {
            display: none;
        }

        .dropzone {
            width: 100%;
            max-width: 720px;
            border: 2px dashed #cfd8dc;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            background: #fff;
            color: #607d8b;
        }

        .dropzone.dragover {
            border-color: #007bff;
            background: #e9f2ff;
            color: #0d47a1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 16px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            animation: spin 1s linear infinite;
            margin: 12px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .content {
            padding: 24px;
            display: none;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: #fff;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .08);
            border-left: 5px solid #007bff;
        }

        .kpi-card.danger {
            border-left-color: #dc3545;
        }

        .kpi-card.success {
            border-left-color: #28a745;
        }

        .kpi-card.warning {
            border-left-color: #ffc107;
        }

        .kpi-number {
            font-size: 2.1rem;
            font-weight: 800;
            color: #2c3e50;
        }

        .kpi-label {
            color: #6c757d;
            font-size: .86rem;
            text-transform: uppercase;
            letter-spacing: .5px;
            font-weight: 700;
        }

        .filters {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            margin-bottom: 12px;
        }

        .filters h3 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        select,
        input[type=text] {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
        }

        select:focus,
        input[type=text]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, .1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .08);
        }

        .chart-title {
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }

        .student-ranking {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .08);
            margin-bottom: 18px;
        }

        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin: 8px 0;
            border-radius: 8px;
        }

        .student-item.high-risk {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: #fff;
        }

        .student-item.medium-risk {
            background: linear-gradient(135deg, #ffd93d, #f9ca24);
            color: #2c3e50;
        }

        .student-item.positive {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: #fff;
        }

        .student-item.normal {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .student-name {
            font-weight: 700;
            font-size: .92rem;
        }

        .student-count {
            font-weight: 800;
        }

        .table-container {
            background: #fff;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .08);
        }

        table.dataTable tbody tr.leve {
            background-color: rgba(255, 193, 7, .10);
        }

        table.dataTable tbody tr.grave {
            background-color: rgba(255, 87, 34, .10);
        }

        table.dataTable tbody tr.gravisima {
            background-color: rgba(244, 67, 54, .18);
        }

        table.dataTable tbody tr.positiva {
            background-color: rgba(76, 175, 80, .10);
        }

        .footer {
            background: #2c3e50;
            color: #fff;
            text-align: center;
            padding: 14px;
            font-weight: 600;
        }

        /* ===== Print (PDF) ===== */
        @media print {

            html,
            body {
                height: auto !important;
                min-height: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                background: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            @page {
                size: A4;
                margin: 12mm;
            }

            .container {
                margin: 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                background: #fff !important;
            }

            .header {
                background: #fff !important;
                color: #000 !important;
                padding: 0 0 8px 0 !important;
                text-align: left !important;
                border-bottom: 1px solid #ddd !important;
            }

            .header h1 {
                font-size: 18px !important;
                margin: 0 0 4px 0 !important;
            }

            .header p {
                font-size: 12px !important;
                margin: 0 !important;
                opacity: 1 !important;
            }

            .upload-section,
            .filters,
            .charts-grid,
            .student-ranking,
            .table-container,
            .footer {
                break-inside: avoid !important;
                box-shadow: none !important;
            }

            .content {
                padding-top: 6px !important;
            }
        }

        /* Overlay de errores (debug) */
        #errorOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            color: #fff;
            z-index: 99999;
            padding: 20px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        }

        #errorOverlay pre {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body>
    <div id="errorOverlay">
        <h3>‚ö†Ô∏è Error</h3>
        <pre id="errorText"></pre>
    </div>

    <div class="container">
        <div class="header">
            <h1>Panel de An√°lisis de Anotaciones Estudiantiles</h1>
            <p>Sistema integral de seguimiento conductual y acad√©mico</p>
        </div>

        <div class="upload-section">
            <div class="uploader">
                <label class="btn">
                    <span>üìÅ Cargar CSV</span>
                    <input id="csvFile" type="file" accept=".csv,text/csv" />
                </label>
                <div id="dropzone" class="dropzone">
                    Arrastra y suelta tu archivo CSV aqu√≠, o usa el bot√≥n ‚ÄúCargar CSV‚Äù.
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Procesando archivo...</p>
                </div>
            </div>
        </div>

        <div class="content" id="content">
            <!-- KPIs -->
            <div class="kpis">
                <div class="kpi-card">
                    <div class="kpi-number" id="totalAnnotations">0</div>
                    <div class="kpi-label">Total Anotaciones</div>
                </div>
                <div class="kpi-card danger">
                    <div class="kpi-number" id="riskStudents">0</div>
                    <div class="kpi-label">Estudiantes en Riesgo</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-number" id="positiveAnnotations">0</div>
                    <div class="kpi-label">Anotaciones Positivas</div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-number" id="topCourse">-</div>
                    <div class="kpi-label">Curso con M√°s Incidencias</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters">
                <h3>üîç Filtros de An√°lisis</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label>Curso</label>
                        <select id="courseFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Categor√≠a</label>
                        <select id="categoryFilter">
                            <option value="">Todas</option>
                            <option>Leve</option>
                            <option>Grave</option>
                            <option>Grav√≠sima</option>
                            <option>Positiva</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Docente</label>
                        <select id="teacherFilter">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <!-- === Buscar Alumno (nuevo) === -->
                    <div class="filter-item">
                        <label>Buscar Alumno</label>
                        <input id="studentSearch" list="studentOptions" type="text"
                            placeholder="Escribe nombre y selecciona..." />
                        <datalist id="studentOptions"></datalist>
                    </div>
                </div>

                <!-- Botones PDF -->
                <div style="display:flex; gap:10px; flex-wrap: wrap; margin: 12px 0 0">
                    <button class="btn" id="btnPDFAlumno" disabled>üßæ Exportar PDF Alumno (detalle)</button>
                    <button class="btn" id="btnPDFCurso" disabled>üè´ Exportar PDF por Curso</button>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">üìä Anotaciones por Curso</div><canvas id="courseChart" width="400"
                        height="300"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ü•ß Distribuci√≥n por Categor√≠a</div><canvas id="categoryChart" width="400"
                        height="300"></canvas>
                </div>
            </div>

            <!-- Ranking -->
            <div class="student-ranking">
                <div class="chart-title">‚ö†Ô∏è Ranking de Estudiantes por Curso</div>
                <div id="studentRanking"></div>
            </div>

            <!-- Tabla general -->
            <div class="table-container">
                <div class="chart-title">üìã Detalle de Anotaciones</div>
                <table id="annotationsTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Estudiante</th>
                            <th>Curso</th>
                            <th>Categor√≠a</th>
                            <th>Motivo</th>
                            <th>Acci√≥n Tomada</th>
                            <th>Asignatura</th>
                            <th>Docente</th>
                            <th>Riesgo</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Detalle Alumno (aparece al buscar) -->
            <div class="table-container" id="studentDetailBox" style="margin-top:14px; display:none">
                <div class="chart-title" id="studentDetailTitle">üë§ Detalle del Alumno</div>
                <table id="studentDetailTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Curso</th>
                            <th>Categor√≠a</th>
                            <th>Motivo</th>
                            <th>Acci√≥n Tomada</th>
                            <th>Asignatura</th>
                            <th>Docente</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>

        <div class="footer">App creada por Juan Pablo Ram√≠rez, experto en IA</div>
    </div>

    <script>
        /* ===== Overlay de errores ===== */
        (function () {
            const overlay = document.getElementById('errorOverlay');
            const pre = document.getElementById('errorText');
            const show = (m) => { pre.textContent = m; overlay.style.display = 'block'; };
            window.addEventListener('error', e => show(`${e.message}\n${e.filename}:${e.lineno}:${e.colno}`));
            window.addEventListener('unhandledrejection', e => show(`Promise rejection: ${e.reason}`));
        })();

        /* ===== Estado ===== */
        let globalData = [];
        let filteredData = [];
        let courseChart = null;
        let categoryChart = null;
        let dataTable = null;
        let studentDetailDT = null;
        let currentStudent = '';

        /* ===== Cat√°logos ===== */
        const courseMapping = {
            "1¬∞-2¬∞ Medio TP P√°rvulos": "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos",
            "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos": "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos"
        };
        const allCourses = [
            "7¬∞ y 8¬∞ B√°sico", "1¬∞ y 2¬∞ Medio HC", "3¬∞ y 4¬∞ Medio HC",
            "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad",
            "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos",
            "3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos",
            "3¬∞ Medio T√©cnico Profesional en Electricidad",
            "4¬∞ Medio T√©cnico Profesional en Electricidad"
        ];
        const categoriesList = ['Leve', 'Grave', 'Grav√≠sima', 'Positiva'];

        /* ===== Utils ===== */
        function normalizeTeacher(t) { if (!t) return 'SIN ESPECIFICAR'; const n = ('' + t).trim().toLowerCase(); if (n.includes('maria') && (n.includes('angeles') || n.includes('√°ngeles')) && n.includes('canales')) return 'MAR√çA √ÅNGELES CANALES'; return ('' + t).trim().toUpperCase(); }
        function normalizeCourse(c) { return c ? (courseMapping[c] || c) : ''; }
        function normalizeKey(k) { if (!k) return ''; return ('' + k).trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s*\/\s*/g, ' / ').replace(/\s+/g, ' '); }

        const HEADER_ALIAS = {
            'fecha': 'Fecha', 'nombre del estudiante': 'Nombre del estudiante', 'estudiante': 'Nombre del estudiante', 'curso': 'curso',
            'categoria': 'categoria', 'categor√≠a': 'categoria', 'motivo': 'motivo', 'accion tomada': 'accion tomada', 'acci√≥n tomada': 'accion tomada',
            'asignatura': 'Asignatura', 'docente /funcionario': 'DOCENTE /FUNCIONARIO', 'docente / funcionario': 'DOCENTE /FUNCIONARIO', 'docente': 'DOCENTE /FUNCIONARIO'
        };

        function libsReady() { return !!(window.jQuery && $.fn && $.fn.DataTable && window.Chart && window.Papa); }
        function pdfLibsReady() { return !!(window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable); }
        function waitFor(test, cb, tries = 50) { if (test()) return cb(); const id = setInterval(() => { if (test()) { clearInterval(id); cb(); } else if (--tries <= 0) { clearInterval(id); } }, 100); }

        /* ===== CSV (Papa) ===== */
        function parseCSVWithPapa(file, ok, fail) {
            Papa.parse(file, {
                header: true, skipEmptyLines: 'greedy', encoding: 'UTF-8',
                transformHeader: (h) => HEADER_ALIAS[normalizeKey(h)] || h,
                complete: (res) => {
                    try {
                        const rows = (res.data || []).map(r => ({
                            'Fecha': r['Fecha'] ?? r['fecha'] ?? '',
                            'Nombre del estudiante': r['Nombre del estudiante'] ?? r['estudiante'] ?? '',
                            'curso': normalizeCourse(r['curso'] ?? ''),
                            'categoria': r['categoria'] ?? r['categor√≠a'] ?? '',
                            'motivo': r['motivo'] ?? '',
                            'accion tomada': r['accion tomada'] ?? r['acci√≥n tomada'] ?? '',
                            'Asignatura': r['Asignatura'] ?? r['asignatura'] ?? '',
                            'DOCENTE /FUNCIONARIO': normalizeTeacher(r['DOCENTE /FUNCIONARIO'] ?? r['docente'] ?? r['docente / funcionario'] ?? '')
                        })).filter(r => Object.values(r).some(v => (v || '').toString().trim() !== ''));
                        if (!rows.length) throw new Error('No se encontraron filas v√°lidas en el CSV.');
                        ok(rows);
                    } catch (e) { fail(e); }
                },
                error: (err) => fail(err)
            });
        }

        /* ===== Render ===== */
        function renderAll() { updateKPIs(); renderCharts(); renderStudentRanking(); refreshTable(); buildStudentIndex(); }

        function updateKPIs() {
            const total = filteredData.length;
            const byStudent = {}; let positives = 0;
            filteredData.forEach(r => {
                const s = r['Nombre del estudiante'] || '(SIN NOMBRE)'; const cat = (r['categoria'] || '').toLowerCase();
                if (!byStudent[s]) byStudent[s] = { total: 0, negative: 0, positive: 0 };
                byStudent[s].total++;
                if (cat.includes('positiv')) { byStudent[s].positive++; positives++; }
                else if (['leve', 'grave', 'grav√≠sima', 'gravisima'].includes(cat)) { byStudent[s].negative++; }
            });
            const riskStudents = Object.values(byStudent).filter(s => s.negative > 6).length;

            const courseCounts = Object.fromEntries(allCourses.map(c => [c, 0]));
            filteredData.forEach(r => { if (courseCounts[r['curso']] != null) courseCounts[r['curso']]++; });
            const top = Object.entries(courseCounts).sort((a, b) => b[1] - a[1])[0];

            document.getElementById('totalAnnotations').textContent = total;
            document.getElementById('riskStudents').textContent = riskStudents;
            document.getElementById('positiveAnnotations').textContent = positives;
            document.getElementById('topCourse').textContent = top && top[1] > 0 ? (top[0].length > 20 ? top[0].slice(0, 20) + '‚Ä¶' : top[0]) : 'N/A';
        }

        function renderCharts() {
            const neg = Object.fromEntries(allCourses.map(c => [c, 0]));
            const pos = Object.fromEntries(allCourses.map(c => [c, 0]));
            filteredData.forEach(r => {
                const c = r['curso']; const cat = (r['categoria'] || '').toLowerCase();
                if (!allCourses.includes(c)) return;
                if (cat.includes('positiv')) pos[c]++; else neg[c]++;
            });

            const ctx1 = document.getElementById('courseChart').getContext('2d');
            if (courseChart) courseChart.destroy();
            courseChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: allCourses.map(c => c.length > 28 ? c.slice(0, 28) + '‚Ä¶' : c),
                    datasets: [
                        { label: 'Anotaciones Negativas', data: allCourses.map(c => neg[c]), backgroundColor: 'rgba(255,99,132,.85)', borderColor: 'rgba(255,99,132,1)', borderWidth: 1 },
                        { label: 'Anotaciones Positivas', data: allCourses.map(c => pos[c]), backgroundColor: 'rgba(75,192,192,.85)', borderColor: 'rgba(75,192,192,1)', borderWidth: 1 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { ticks: { maxRotation: 45, minRotation: 45 } } } }
            });

            const counts = categoriesList.map(cat => filteredData.filter(r => {
                const rc = (r['categoria'] || '').toLowerCase();
                if (cat === 'Positiva') return rc.includes('positiv');
                return rc === cat.toLowerCase() || (cat === 'Grav√≠sima' && rc === 'gravisima');
            }).length);
            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(ctx2, {
                type: 'pie',
                data: { labels: categoriesList, datasets: [{ data: counts, backgroundColor: ['rgba(255,193,7,.85)', 'rgba(255,87,34,.85)', 'rgba(244,67,54,.85)', 'rgba(76,175,80,.85)'], borderColor: ['rgba(255,193,7,1)', 'rgba(255,87,34,1)', 'rgba(244,67,54,1)', 'rgba(76,175,80,1)'], borderWidth: 2 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderStudentRanking() {
            const byCourse = Object.fromEntries(allCourses.map(c => [c, {}]));
            filteredData.forEach(r => {
                const c = r['curso']; if (!byCourse[c]) return;
                const s = r['Nombre del estudiante'] || '(SIN NOMBRE)';
                const cat = (r['categoria'] || '').toLowerCase();
                if (!byCourse[c][s]) byCourse[c][s] = { total: 0, negative: 0, positive: 0 };
                byCourse[c][s].total++;
                if (cat.includes('positiv')) byCourse[c][s].positive++; else if (['leve', 'grave', 'grav√≠sima', 'gravisima'].includes(cat)) byCourse[c][s].negative++;
            });

            let html = '';
            allCourses.forEach(c => {
                const arr = Object.entries(byCourse[c]).sort(([, a], [, b]) => b.total - a.total).slice(0, 10);
                if (!arr.length) return;
                html += `<h4 style="color:#2c3e50;margin:14px 0 6px;border-bottom:2px solid #3498db;padding-bottom:4px">${c}</h4>`;
                arr.forEach(([name, counts]) => {
                    let cls = 'normal'; if (counts.negative > 6) cls = 'high-risk'; else if (counts.negative >= 3) cls = 'medium-risk'; else if (counts.positive > 0) cls = 'positive';
                    html += `<div class="student-item ${cls}"><span class="student-name">${name}</span><span class="student-count">${counts.total} anotaciones</span></div>`;
                });
            });
            if (!html) html = '<p style="text-align:center;color:#6c757d;padding:10px">No hay datos para mostrar</p>';
            document.getElementById('studentRanking').innerHTML = html;
        }

        /* ===== Tabla General ===== */
        function ensureDataTable() {
            if (dataTable) return;
            dataTable = $('#annotationsTable').DataTable({
                pageLength: 25,
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
                columnDefs: [{ targets: [8], orderable: false }],
                order: [[0, 'desc']],
                createdRow: (row, data) => {
                    const cat = (data[3] || '').toLowerCase();
                    if (cat.includes('positiv')) $(row).addClass('positiva');
                    else if (cat === 'grav√≠sima' || cat === 'gravisima') $(row).addClass('gravisima');
                    else if (cat === 'grave') $(row).addClass('grave');
                    else if (cat === 'leve') $(row).addClass('leve');
                }
            });
        }
        function refreshTable() {
            ensureDataTable();
            const negByStudent = {};
            globalData.forEach(r => {
                const s = r['Nombre del estudiante'] || '(SIN NOMBRE)';
                const cat = (r['categoria'] || '').toLowerCase();
                if (!negByStudent[s]) negByStudent[s] = 0;
                if (['leve', 'grave', 'grav√≠sima', 'gravisima'].includes(cat)) negByStudent[s]++;
            });
            const rows = filteredData.map(r => {
                const s = r['Nombre del estudiante'] || '(SIN NOMBRE)';
                const neg = negByStudent[s] || 0;
                let risk = ''; if (neg > 6) risk = 'üî¥ ALTO RIESGO'; else if (neg >= 3) risk = 'üü° ATENCI√ìN'; else if ((r['categoria'] || '').toLowerCase().includes('positiv')) risk = 'üü¢ POSITIVO';
                const trunc = (t = '') => t.length > 100 ? t.slice(0, 100) + '‚Ä¶' : t;
                return [r['Fecha'] || '', s, r['curso'] || '', r['categoria'] || '', trunc(r['motivo']), trunc(r['accion tomada']), r['Asignatura'] || '', r['DOCENTE /FUNCIONARIO'] || '', risk];
            });
            dataTable.clear(); dataTable.rows.add(rows); dataTable.draw();
        }

        /* ===== Buscar Alumno ===== */
        function buildStudentIndex() {
            const students = [...new Set(globalData.map(r => (r['Nombre del estudiante'] || '').trim()).filter(Boolean))].sort();
            const dl = document.getElementById('studentOptions');
            dl.innerHTML = students.map(s => `<option value="${s}">`).join('');
        }

        function showStudentDetail(name) {
            currentStudent = name;
            const box = document.getElementById('studentDetailBox');
            const title = document.getElementById('studentDetailTitle');
            if (!name) { box.style.display = 'none'; return; }

            const rows = globalData.filter(r => (r['Nombre del estudiante'] || '').trim() === name.trim());
            title.textContent = `üë§ Detalle del Alumno: ${name}  ‚Äî  ${rows.length} anotaciones`;
            box.style.display = 'block';

            if (!studentDetailDT) {
                studentDetailDT = $('#studentDetailTable').DataTable({
                    pageLength: 25,
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
                    order: [[0, 'desc']]
                });
            }
            const body = rows.map(r => [
                r['Fecha'] || '', r['curso'] || '', r['categoria'] || '',
                (r['motivo'] || ''), (r['accion tomada'] || ''), r['Asignatura'] || '', r['DOCENTE /FUNCIONARIO'] || ''
            ]);
            studentDetailDT.clear(); studentDetailDT.rows.add(body); studentDetailDT.draw();

            // Habilitar PDF alumno si hay librer√≠as
            document.getElementById('btnPDFAlumno').disabled = !pdfLibsReady();
        }

        /* ===== Filtros ===== */
        function populateFilters() {
            const courseSel = document.getElementById('courseFilter');
            courseSel.innerHTML = '<option value="">Todos</option>' + allCourses.map(c => `<option value="${c}">${c}</option>`).join('');
            const teachers = [...new Set(globalData.map(r => normalizeTeacher(r['DOCENTE /FUNCIONARIO'])))]
                .filter(Boolean).sort();
            document.getElementById('teacherFilter').innerHTML = '<option value="">Todos</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
            buildStudentIndex();
        }
        function applyFilters() {
            const c = document.getElementById('courseFilter').value;
            const cat = document.getElementById('categoryFilter').value;
            const t = document.getElementById('teacherFilter').value;

            filteredData = globalData.filter(r => {
                if (c && r['curso'] !== c) return false;
                if (cat) {
                    const rc = (r['categoria'] || '').toLowerCase();
                    if (cat === 'Positiva') { if (!rc.includes('positiv')) return false; }
                    else { if (rc !== cat.toLowerCase() && !(cat === 'Grav√≠sima' && rc === 'gravisima')) return false; }
                }
                if (t && normalizeTeacher(r['DOCENTE /FUNCIONARIO']) !== t) return false;
                return true;
            });
            renderAll();
        }
        function clearStudentDetail() { currentStudent = ''; document.getElementById('studentSearch').value = ''; document.getElementById('studentDetailBox').style.display = 'none'; }

        /* ===== PDF helpers ===== */
        function formatNow() { const d = new Date(); const pad = n => String(n).padStart(2, '0'); return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
        function aggregateByCourse(rows) {
            const byCourse = {};
            rows.forEach(r => {
                const c = r['curso'] || '(SIN CURSO)'; const s = r['Nombre del estudiante'] || '(SIN NOMBRE)'; const cat = (r['categoria'] || '').toLowerCase();
                if (!byCourse[c]) byCourse[c] = { total: 0, leves: 0, graves: 0, gravisimas: 0, positivas: 0, estudiantes: {} };
                byCourse[c].total++;
                if (cat.includes('positiv')) byCourse[c].positivas++; else if (cat === 'leve') byCourse[c].leves++; else if (cat === 'grave') byCourse[c].graves++; else if (cat === 'grav√≠sima' || cat === 'gravisima') byCourse[c].gravisimas++;
                if (!byCourse[c].estudiantes[s]) byCourse[c].estudiantes[s] = { total: 0, negativas: 0, positivas: 0 };
                byCourse[c].estudiantes[s].total++;
                if (cat.includes('positiv')) byCourse[c].estudiantes[s].positivas++; else if (['leve', 'grave', 'grav√≠sima', 'gravisima'].includes(cat)) byCourse[c].estudiantes[s].negativas++;
            });
            return byCourse;
        }

        function exportPDFAlumno() {
            if (!pdfLibsReady() || !currentStudent) return;
            const rows = globalData.filter(r => (r['Nombre del estudiante'] || '').trim() === currentStudent.trim());
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            let y = 40;

            doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
            doc.text(`Reporte de Anotaciones ‚Äî Alumno`, 40, y); y += 18;
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(`Alumno: ${currentStudent}`, 40, y); y += 12;
            const curso = (rows[0]?.curso) || '';
            if (curso) { doc.text(`Curso: ${curso}`, 40, y); y += 12; }
            doc.text(`Generado: ${formatNow()}   |   Total de anotaciones: ${rows.length}`, 40, y); y += 10;

            // Tabla con TODAS las anotaciones del alumno
            const body = rows.map(r => [
                r['Fecha'] || '', r['curso'] || '', r['categoria'] || '',
                (r['motivo'] || ''), (r['accion tomada'] || ''), r['Asignatura'] || '', r['DOCENTE /FUNCIONARIO'] || ''
            ]);
            y += 8; // separaci√≥n para evitar ‚Äúpegado‚Äù
            doc.autoTable({
                startY: y,
                head: [['Fecha', 'Curso', 'Categor√≠a', 'Motivo', 'Acci√≥n Tomada', 'Asignatura', 'Docente']],
                body,
                styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
                headStyles: { fillColor: [30, 144, 255] },
                margin: { left: 40, right: 40 }
            });

            doc.save(`Anotaciones_${currentStudent.replace(/\s+/g, '_')}_${Date.now()}.pdf`);
        }

        function exportPDFPorCurso() {
            if (!pdfLibsReady()) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            let y = 40;

            // Encabezado general
            doc.setFont('helvetica', 'bold'); doc.setFontSize(14);
            doc.text('Reporte de Anotaciones - Resumen por Curso', 40, y); y += 18;
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(`Generado: ${formatNow()}`, 40, y); y += 16; // + espacio extra para que no se pegue

            const source = filteredData.length ? filteredData : globalData;
            const byCourse = aggregateByCourse(source);
            const courses = Object.keys(byCourse);
            if (!courses.length) { doc.text('No hay datos para mostrar.', 40, y); doc.save(`Anotaciones_Cursos_${Date.now()}.pdf`); return; }

            courses.forEach((c, idx) => {
                if (idx > 0) doc.addPage({ format: 'a4', unit: 'pt' });
                y = 40;

                // T√≠tulo del curso
                doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
                doc.text(`${c}`, 40, y); y += 18;

                // Subt√≠tulo (totales) con separaci√≥n controlada
                doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
                const info = byCourse[c];
                doc.text(`Totales del curso:  Total=${info.total} | Leves=${info.leves} | Graves=${info.graves} | Grav√≠simas=${info.gravisimas} | Positivas=${info.positivas}`, 40, y);
                y += 14; // <-- separaci√≥n adicional para evitar pegado con la tabla

                // Tabla estudiantes del curso
                const estRows = Object.entries(info.estudiantes)
                    .sort(([, a], [, b]) => b.total - a.total)
                    .map(([est, v]) => [
                        est, v.total, v.negativas, v.positivas,
                        (v.negativas > 6 ? 'ALTO RIESGO' : (v.negativas >= 3 ? 'ATENCI√ìN' : (v.positivas > 0 ? 'POSITIVO' : '')))
                    ]);

                doc.autoTable({
                    startY: y,
                    head: [['Estudiante', 'Total', 'Negativas', 'Positivas', 'Etiqueta']],
                    body: estRows,
                    styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
                    headStyles: { fillColor: [30, 144, 255] },
                    margin: { left: 40, right: 40 }
                });
            });

            doc.save(`Anotaciones_ResumenPorCurso_${Date.now()}.pdf`);
        }

        function setupPdfButtons() {
            const ok = pdfLibsReady();
            document.getElementById('btnPDFCurso').disabled = !ok;
            // btnPDFAlumno se habilita cuando eliges alumno y est√°n las libs
        }

        /* ===== Carga archivo ===== */
        function handleFiles(file) {
            if (!file) return;
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            loading.style.display = 'block'; content.style.display = 'none';
            parseCSVWithPapa(file, (rows) => {
                globalData = rows; filteredData = [...globalData];
                populateFilters(); renderAll();
                loading.style.display = 'none'; content.style.display = 'block';
            }, (err) => {
                loading.style.display = 'none';
                alert('Error al procesar el archivo: ' + (err?.message || err));
            });
        }

        function setupUpload() {
            const fileInput = document.getElementById('csvFile');
            const drop = document.getElementById('dropzone');
            fileInput.addEventListener('change', e => handleFiles(e.target.files[0]));
            if (drop) {
                ['dragenter', 'dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); }));
                ['dragleave', 'dragend', 'drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); }));
                drop.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; handleFiles(f); });
            }

            document.getElementById('courseFilter').addEventListener('change', () => { clearStudentDetail(); applyFilters(); });
            document.getElementById('categoryFilter').addEventListener('change', () => { clearStudentDetail(); applyFilters(); });
            document.getElementById('teacherFilter').addEventListener('change', () => { clearStudentDetail(); applyFilters(); });

            // Buscar Alumno: al elegir del datalist mostramos el detalle
            const studentSearch = document.getElementById('studentSearch');
            studentSearch.addEventListener('change', () => {
                const name = studentSearch.value.trim();
                if (name && globalData.some(r => (r['Nombre del estudiante'] || '').trim() === name)) {
                    showStudentDetail(name);
                } else {
                    clearStudentDetail();
                }
            });

            // Botones PDF
            document.getElementById('btnPDFAlumno').addEventListener('click', exportPDFAlumno);
            document.getElementById('btnPDFCurso').addEventListener('click', exportPDFPorCurso);
        }

        /* ===== Boot ===== */
        document.addEventListener('DOMContentLoaded', () => {
            waitFor(libsReady, () => {
                setupUpload();
                populateFilters(); // vac√≠o hasta cargar CSV
                waitFor(pdfLibsReady, setupPdfButtons, 20);
            }, 50);
        });
    </script>
</body>

</html>