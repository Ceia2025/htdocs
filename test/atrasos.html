<script>
    function doGet() {
        return HtmlService
            .createHtmlOutputFromFile('index')
            .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL); // Permite embeber en iframe
    }

</script>


<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Atrasos ‚Äì CEIA (pre-cargado + CSV + PDF/CSV export)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- PDF libs -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2"></script>
    <style>
        body {
            background: #f8f9fa;
        }

        .card {
            margin-bottom: 1rem;
        }

        .chart-container {
            position: relative;
            height: 320px;
        }

        .risk-badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
        }

        .risk-bajo {
            background: #d4edda;
            color: #155724;
        }

        .risk-medio {
            background: #fff3cd;
            color: #856404;
        }

        .risk-alto {
            background: #f8d7da;
            color: #721c24;
        }

        footer {
            border-top: 1px solid #e5e5e5;
            padding: 16px 0;
            color: #6c757d;
            text-align: center;
            margin-top: 32px;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <h1 class="h3 m-0">üìä Dashboard de Atrasos ‚Äì CEIA</h1>
            <div class="d-flex flex-wrap gap-2">
                <label class="btn btn-outline-primary mb-0">
                    üì• Actualizar datos (CSV)
                    <input id="file-input" type="file" accept=".csv,text/csv" hidden>
                </label>
                <button id="btn-reload" class="btn btn-outline-success">‚úÖ Reiniciar a datos iniciales</button>
                <button id="btn-reset" class="btn btn-outline-secondary">‚ôªÔ∏è Reiniciar filtros</button>
            </div>
        </div>

        <!-- M√©tricas -->
        <div class="row g-3">
            <div class="col-6 col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="h3 mb-0" id="m-total">0</div>
                        <small class="text-muted">Total Atrasos</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="h3 mb-0" id="m-estudiantes">0</div>
                        <small class="text-muted">Estudiantes</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="h3 mb-0" id="m-cursos">0</div>
                        <small class="text-muted">Cursos</small>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="h3 mb-0" id="m-prom">0</div>
                        <small class="text-muted">Atrasos / Estudiante</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><strong>üë• Estudiantes por Curso</strong></div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="g-estudiantes-curso"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header"><strong>‚è±Ô∏è Promedio de Atrasos por Curso</strong></div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="g-promedio-curso"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header"><strong>üìÖ Tendencia Temporal (mes)</strong></div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="g-tendencia"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="row g-3 mt-1">
            <div class="col-md-4">
                <label class="form-label">üîç Buscar estudiante</label>
                <input type="text" id="q" class="form-control" placeholder="Nombre del estudiante..." />
            </div>
            <div class="col-md-4">
                <label class="form-label">üìö Curso</label>
                <select id="f-curso" class="form-select">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">‚ö†Ô∏è Riesgo</label>
                <select id="f-riesgo" class="form-select">
                    <option value="">Todos</option>
                    <option value="Bajo">üü¢ Bajo</option>
                    <option value="Medio">üü° Medio</option>
                    <option value="Alto">üî¥ Alto</option>
                </select>
            </div>
        </div>

        <!-- Exportadores -->
        <div class="card mt-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <strong>üìÑ Exportar reportes</strong>
            </div>
            <div class="card-body">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">üìö Selecciona un curso (PDF por curso)</label>
                        <select id="pdf-curso" class="form-select">
                            <option value="">‚Äî Elegir curso ‚Äî</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button id="btn-pdf" class="btn btn-danger w-100">‚¨áÔ∏è Descargar PDF (curso)</button>
                    </div>
                    <div class="col-md-3">
                        <button id="btn-pdf-all" class="btn btn-dark w-100">üìö‚¨áÔ∏è PDF (todos los cursos)</button>
                    </div>
                </div>
                <div class="row g-2 align-items-end mt-2">
                    <div class="col-md-6">
                        <small class="text-muted d-block">El PDF incluye: Estudiante, Total de atrasos, Promedio (min),
                            √öltimo atraso y Riesgo.</small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <button id="btn-csv-filtrado" class="btn btn-outline-primary">‚¨áÔ∏è Descargar CSV (seg√∫n
                            filtros)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card mt-3">
            <div class="card-header d-flex align-items-center justify-content-between">
                <strong>üë• Resumen Individual de Estudiantes</strong>
                <span class="badge text-bg-primary" id="count">0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 60vh;">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Estudiante</th>
                                <th>Curso</th>
                                <th>Total</th>
                                <th>Promedio (min)</th>
                                <th>√öltimo</th>
                                <th>Riesgo</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle de Atrasos</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <footer>App creada por Juan P. Ramirez exporto en IA</footer>

    <script>
        // ===================== CONFIGURACI√ìN =====================
        const CURSOS_FINALES = [
            "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad",
            "3¬∞ Medio T√©cnico Profesional en Electricidad",
            "4¬∞ Medio T√©cnico Profesional en Electricidad",
            "1¬∞ y 2¬∞ Medio HC",
            "3¬∞ y 4¬∞ Medio HC",
            "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos",
            "3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos",
            "4¬∞ Medio T√©cnico Profesional de P√°rvulo",
            "7¬∞ y 8¬∞ B√°sico"
        ];

        // ===================== DATOS INICIALES (EMBEBIDOS) =====================
        // Datos de ejemplo (resumen) para precargar. Al subir un CSV, todo se recalcula con tus datos reales.
        const initialDashboardData = {
            "metricas_generales": {
                "total_registros": 823,
                "total_estudiantes": 128,
                "total_cursos": 9,
                "promedio_atrasos_por_estudiante": 6.43,
                "promedio_minutos_general": 35.0
            },
            "cursos_homologados": CURSOS_FINALES,
            "stats_por_curso": {
                "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad": { "estudiantes_unicos": 40, "promedio_minutos": 35, "total_atrasos": 111 },
                "3¬∞ Medio T√©cnico Profesional en Electricidad": { "estudiantes_unicos": 25, "promedio_minutos": 35, "total_atrasos": 81 },
                "4¬∞ Medio T√©cnico Profesional en Electricidad": { "estudiantes_unicos": 15, "promedio_minutos": 35, "total_atrasos": 28 },
                "1¬∞ y 2¬∞ Medio HC": { "estudiantes_unicos": 60, "promedio_minutos": 35, "total_atrasos": 394 },
                "3¬∞ y 4¬∞ Medio HC": { "estudiantes_unicos": 45, "promedio_minutos": 35, "total_atrasos": 0 },
                "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos": { "estudiantes_unicos": 20, "promedio_minutos": 35, "total_atrasos": 67 },
                "3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos": { "estudiantes_unicos": 18, "promedio_minutos": 35, "total_atrasos": 56 },
                "4¬∞ Medio T√©cnico Profesional de P√°rvulo": { "estudiantes_unicos": 17, "promedio_minutos": 35, "total_atrasos": 60 },
                "7¬∞ y 8¬∞ B√°sico": { "estudiantes_unicos": 10, "promedio_minutos": 35, "total_atrasos": 20 }
            },
            "tendencia_temporal": {
                "2025-03": 99, "2025-04": 206, "2025-05": 116,
                "2025-06": 62, "2025-07": 136, "2025-08": 181, "2025-09": 23
            },
            "distribucion_riesgo": { "Bajo": 47, "Medio": 28, "Alto": 53 },
            "registros_detallados": [],
            "stats_estudiantes": {}
        };

        // ===================== MAPEO CURSOS =====================
        function mapCurso(original) {
            const s = String(original || "").trim();
            const map = new Map([
                // Electricidad
                ["1¬∞-2¬∞ Medio TP Electricidad", "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad"],
                ["1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad", "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Electricidad"],
                ["3¬∞ Medio TP Electricidad", "3¬∞ Medio T√©cnico Profesional en Electricidad"],
                ["3¬∞ Medio T√©cnico Profesional en Electricidad", "3¬∞ Medio T√©cnico Profesional en Electricidad"],
                ["4¬∞ Medio TP Electricidad", "4¬∞ Medio T√©cnico Profesional en Electricidad"],
                ["4¬∞ Medio T√©cnico Profesional en Electricidad", "4¬∞ Medio T√©cnico Profesional en Electricidad"],
                // HC
                ["1¬∞ y 2¬∞ Medio HC", "1¬∞ y 2¬∞ Medio HC"],
                ["3¬∞ y 4¬∞ Medio HC", "3¬∞ y 4¬∞ Medio HC"],
                ["3¬∞ y 4¬∞ Medio HC A", "3¬∞ y 4¬∞ Medio HC"],
                // P√°rvulos (uni√≥n 1-2)
                ["1¬∞-2¬∞ Medio TP P√°rvulos", "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos"],
                ["1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos", "1¬∞ y 2¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos"],
                ["3¬∞ Medio TP P√°rvulos", "3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos"],
                ["3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos", "3¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos"],
                ["4¬∞ Medio TP P√°rvulos", "4¬∞ Medio T√©cnico Profesional de P√°rvulo"],
                ["4¬∞ Medio T√©cnico Profesional en Atenci√≥n de P√°rvulos", "4¬∞ Medio T√©cnico Profesional de P√°rvulo"],
                // B√°sica
                ["7¬∞ y 8¬∞ B√°sico", "7¬∞ y 8¬∞ B√°sico"]
            ]);
            return map.get(s) || null;
        }

        // ===================== UTILIDADES =====================
        function toMinutes(val) {
            if (val === null || val === undefined) return 15;
            const s = String(val).toLowerCase();
            if (s.includes("hora")) return 60;
            if (s.includes("45") || s.includes("30")) return 35;
            if (s.includes("15") || s.includes("10")) return 15;
            const m = s.match(/\d+/);
            if (m) {
                const n = parseInt(m[0], 10);
                if (n >= 60) return 60;
                if (n >= 40) return 45;
                if (n >= 25) return 35;
                return 15;
            }
            return 20;
        }
        function riesgo(n) {
            if (n <= 2) return "Bajo";
            if (n <= 5) return "Medio";
            return "Alto";
        }

        // ===================== ESTADO =====================
        let dashboardData = JSON.parse(JSON.stringify(initialDashboardData));
        let charts = {};

        // ===================== INICIALIZACI√ìN =====================
        document.addEventListener("DOMContentLoaded", () => {
            // Filtros de curso (los 9 can√≥nicos)
            const s = document.getElementById("f-curso");
            CURSOS_FINALES.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c; opt.textContent = c; s.appendChild(opt);
            });

            // Selector de PDF por curso
            const selPdf = document.getElementById("pdf-curso");
            CURSOS_FINALES.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c; opt.textContent = c; selPdf.appendChild(opt);
            });

            // Listeners
            document.getElementById("q").addEventListener("input", renderTabla);
            document.getElementById("f-curso").addEventListener("change", renderTabla);
            document.getElementById("f-riesgo").addEventListener("change", renderTabla);
            document.getElementById("btn-reset").addEventListener("click", resetFiltros);
            document.getElementById("btn-reload").addEventListener("click", reloadInitial);
            document.getElementById("file-input").addEventListener("change", onFileSelected);
            document.getElementById("btn-pdf").addEventListener("click", descargarPDFCurso);
            document.getElementById("btn-pdf-all").addEventListener("click", descargarPDFTodos);
            document.getElementById("btn-csv-filtrado").addEventListener("click", descargarCSVFiltrado);

            // Render inicial
            renderAll();
        });

        // ===================== CARGA CSV =====================
        function onFileSelected(ev) {
            const file = ev.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8",
                complete: (res) => {
                    try {
                        const rows = res.data;
                        const newData = buildFromCSV(rows);
                        dashboardData = newData;
                        renderAll();
                    } catch (e) {
                        alert("Error procesando el CSV: " + e.message);
                        console.error(e);
                    }
                },
                error: (err) => {
                    alert("No se pudo leer el CSV. " + err.message);
                    console.error(err);
                }
            });
        }

        // ===================== PROCESAMIENTO =====================
        function buildFromCSV(rows) {
            const norm = (s) => String(s || "").trim().toLowerCase();
            const mapCols = {
                "fecha del atraso": "Fecha del Atraso",
                "fecha_atraso": "Fecha del Atraso",
                "fecha": "Fecha del Atraso",
                "fecha atraso": "Fecha del Atraso",
                "curso": "curso",
                "cursos": "curso",
                "nombre del estudiante": "nombre del estudiante",
                "estudiante": "nombre del estudiante",
                "nombre": "nombre del estudiante",
                "tiempo de atraso": "Tiempo de atraso",
                "tiempo_atraso": "Tiempo de atraso",
                "minutos": "Tiempo de atraso",
                "minutos atraso": "Tiempo de atraso",
                "registrado por": "Registrado por",
                "registrador": "Registrado por",
                "funcionario": "Registrado por",
                "ingresado por": "Registrado por"
            };

            const cleaned = rows.map(r => {
                const o = {};
                for (const [k, v] of Object.entries(r)) {
                    const kk = mapCols[norm(k)];
                    if (kk) o[kk] = v;
                }
                return o;
            }).filter(o => o["Fecha del Atraso"] && o["curso"] && o["nombre del estudiante"]);

            const detalle = [];
            for (const o of cleaned) {
                const can = mapCurso( o ["curso"]);
                if (!can) continue;
                const fecha = new Date( o ["Fecha del Atraso"]);
                if (isNaN(fecha.getTime())) continue;
                const minutos = toMinutes( o ["Tiempo de atraso"]);
                detalle.push({
                    "nombre del estudiante": String(o["nombre del estudiante"]).trim(),
                    "curso_homologado": can,
                    "Fecha del Atraso": fecha.toISOString().slice(0, 10),
                    "minutos_atraso": minutos
                });
            }

            // M√©tricas
            const totalReg = detalle.length;
            const estSet = new Set(detalle.map(d => d["nombre del estudiante"]));
            const cursoSet = new Set(detalle.map(d => d["curso_homologado"]));
            const promEst = estSet.size ? (totalReg / estSet.size) : 0;
            const promMin = detalle.length ? (detalle.reduce((a, b) => a + b.minutos_atraso, 0) / detalle.length) : 0;

            // Stats por curso (9 etiquetas)
            const statsCurso = {};
            CURSOS_FINALES.forEach(c => statsCurso[c] = { estudiantes_unicos: 0, promedio_minutos: 0, total_atrasos: 0 });
            const estudiantesPorCurso = {};
            for (const d of detalle) {
                const c = d["curso_homologado"];
                statsCurso[c].total_atrasos += 1;
                statsCurso[c].promedio_minutos += d.minutos_atraso;
                if (!estudiantesPorCurso[c]) estudiantesPorCurso[c] = new Set();
                estudiantesPorCurso[c].add(d["nombre del estudiante"]);
            }
            for (const c of Object.keys(statsCurso)) {
                const u = estudiantesPorCurso[c] ? estudiantesPorCurso[c].size : 0;
                statsCurso[c].estudiantes_unicos = u;
                statsCurso[c].promedio_minutos = statsCurso[c].total_atrasos ? +(statsCurso[c].promedio_minutos / statsCurso[c].total_atrasos).toFixed(2) : 0;
            }

            // Stats por estudiante
            const statsEst = {};
            const ultimoPorEst = {};
            const sumMinPorEst = {};
            for (const d of detalle) {
                const nom = d["nombre del estudiante"];
                if (!statsEst[nom]) statsEst[nom] = { total_atrasos: 0, ultimo_atraso: "", promedio_minutos: 0, curso: d["curso_homologado"], riesgo: "" };
                statsEst[nom].total_atrasos += 1;
                const f = d["Fecha del Atraso"];
                if (!ultimoPorEst[nom] || f > ultimoPorEst[nom]) ultimoPorEst[nom] = f;
                sumMinPorEst[nom] = (sumMinPorEst[nom] || 0) + d.minutos_atraso;
            }
            for (const nom of Object.keys(statsEst)) {
                statsEst[nom].ultimo_atraso = ultimoPorEst[nom] || "";
                statsEst[nom].promedio_minutos = +(sumMinPorEst[nom] / statsEst[nom].total_atrasos).toFixed(2);
                statsEst[nom].riesgo = riesgo(statsEst[nom].total_atrasos);
            }

            // Tendencia mensual
            const tend = {};
            for (const d of detalle) {
                const m = d["Fecha del Atraso"].slice(0, 7);
                tend[m] = (tend[m] || 0) + 1;
            }

            // Distribuci√≥n de riesgo
            const dist = { Bajo: 0, Medio: 0, Alto: 0 };
            for (const v of Object.values(statsEst)) dist[v.riesgo] += 1;

            return {
                metricas_generales: {
                    total_registros: totalReg,
                    total_estudiantes: estSet.size,
                    total_cursos: cursoSet.size,
                    promedio_atrasos_por_estudiante: +promEst.toFixed(2),
                    promedio_minutos_general: +promMin.toFixed(2)
                },
                cursos_homologados: CURSOS_FINALES,
                stats_por_curso: statsCurso,
                tendencia_temporal: tend,
                distribucion_riesgo: dist,
                registros_detallados: detalle,
                stats_estudiantes: statsEst
            };
        }

        // ===================== RENDER =====================
        function renderAll() {
            document.getElementById("m-total").textContent = dashboardData.metricas_generales.total_registros || 0;
            document.getElementById("m-estudiantes").textContent = dashboardData.metricas_generales.total_estudiantes || 0;
            document.getElementById("m-cursos").textContent = dashboardData.metricas_generales.total_cursos || 0;
            document.getElementById("m-prom").textContent = dashboardData.metricas_generales.promedio_atrasos_por_estudiante || 0;

            drawCharts();
            renderTabla();
        }

        function destroyChart(id) {
            if (charts[id]) { charts[id].destroy(); charts[id] = null; }
        }

        function drawCharts() {
            const labels = Object.keys(dashboardData.stats_por_curso);
            const estu = labels.map(k => dashboardData.stats_por_curso[k].estudiantes_unicos);
            const prom = labels.map(k => {
                const sc = dashboardData.stats_por_curso[k];
                const val = sc.estudiantes_unicos ? (sc.total_atrasos / sc.estudiantes_unicos) : 0;
                return +val.toFixed(2);
            });
            const meses = Object.keys(dashboardData.tendencia_temporal).sort();
            const tvals = meses.map(m => dashboardData.tendencia_temporal[m]);

            destroyChart("a"); destroyChart("b"); destroyChart("c");

            charts.a = new Chart(document.getElementById("g-estudiantes-curso"), {
                type: "bar",
                data: { labels, datasets: [{ label: "Estudiantes", data: estu }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            charts.b = new Chart(document.getElementById("g-promedio-curso"), {
                type: "bar",
                data: { labels, datasets: [{ label: "Promedio atrasos/est.", data: prom }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            charts.c = new Chart(document.getElementById("g-tendencia"), {
                type: "line",
                data: { labels: meses, datasets: [{ label: "Atrasos por mes", data: tvals }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function resetFiltros() {
            document.getElementById("q").value = "";
            document.getElementById("f-curso").value = "";
            document.getElementById("f-riesgo").value = "";
            renderTabla();
        }

        function reloadInitial() {
            dashboardData = JSON.parse(JSON.stringify(initialDashboardData)); // volver a los datos embebidos
            resetFiltros();
            renderAll();
        }

        function renderTabla() {
            const q = document.getElementById("q").value.toLowerCase();
            const fc = document.getElementById("f-curso").value;
            const fr = document.getElementById("f-riesgo").value;
            const body = document.getElementById("tbody");
            body.innerHTML = "";

            let entries = Object.entries(dashboardData.stats_estudiantes || {});

            if (q) entries = entries.filter(([nom, _]) => nom.toLowerCase().includes(q));
            if (fc) entries = entries.filter(([_, v]) => v.curso === fc);
            if (fr) entries = entries.filter(([_, v]) => v.riesgo === fr);

            entries.sort((a, b) => b[1].total_atrasos - a[1].total_atrasos);

            for (const [nom, v] of entries) {
                const tr = document.createElement("tr");
                const clase = v.riesgo === "Alto" ? "risk-alto" : (v.riesgo === "Medio" ? "risk-medio" : "risk-bajo");
                tr.innerHTML = `
      <td>${nom}</td>
      <td>${v.curso}</td>
      <td><strong>${v.total_atrasos}</strong></td>
      <td>${Number(v.promedio_minutos).toFixed(1)}</td>
      <td>${v.ultimo_atraso ? new Date(v.ultimo_atraso).toLocaleDateString() : ""}</td>
      <td><span class="risk-badge ${clase}">${v.riesgo}</span></td>
      <td><button class="btn btn-sm btn-outline-primary" onclick="ver('${nom.replace(/'/g, "\\'")}')">Ver</button></td>
    `;
                body.appendChild(tr);
            }
            document.getElementById("count").textContent = entries.length;
        }

        function ver(nombre) {
            const v = dashboardData.stats_estudiantes[nombre];
            const registros = (dashboardData.registros_detallados || [])
                .filter(r => r["nombre del estudiante"] === nombre)
                .sort((a, b) => new Date(b["Fecha del Atraso"]) - new Date(a["Fecha del Atraso"]));

            let html = `
    <div class="row mb-2">
      <div class="col-md-6"><strong>Estudiante:</strong> ${nombre}</div>
      <div class="col-md-6"><strong>Curso:</strong> ${v?.curso || ""}</div>
    </div>
    <div class="row mb-2">
      <div class="col-md-4"><strong>Total:</strong> ${v?.total_atrasos ?? ""}</div>
      <div class="col-md-4"><strong>Promedio (min):</strong> ${v ? Number(v.promedio_minutos).toFixed(1) : ""}</div>
      <div class="col-md-4"><strong>√öltimo:</strong> ${v?.ultimo_atraso ? new Date(v.ultimo_atraso).toLocaleDateString() : ""}</div>
    </div>
    <h6>Historial de atrasos</h6>
    <div class="table-responsive" style="max-height:50vh;">
      <table class="table table-sm table-striped">
        <thead><tr><th>Fecha</th><th>Minutos</th></tr></thead>
        <tbody>
  `;
            for (const r of registros) {
                html += `<tr><td>${new Date(r["Fecha del Atraso"]).toLocaleDateString()}</td><td>${r["minutos_atraso"]}</td></tr>`;
            }
            html += `</tbody></table></div>`;

            document.getElementById("modal-body").innerHTML = html;
            new bootstrap.Modal(document.getElementById("modal")).show();
        }

        // ===================== EXPORTADORES =====================
        // PDF por curso
        function descargarPDFCurso() {
            const curso = (document.getElementById("pdf-curso") || {}).value || "";
            if (!curso) {
                alert("Selecciona un curso para generar el PDF.");
                return;
            }
            const items = Object.entries(dashboardData.stats_estudiantes || {})
                .filter(([_, v]) => v.curso === curso)
                .map(([nombre, v]) => ({
                    nombre,
                    total: v.total_atrasos,
                    prom: Number(v.promedio_minutos || 0).toFixed(1),
                    ultimo: v.ultimo_atraso ? new Date(v.ultimo_atraso).toLocaleDateString() : "",
                    riesgo: v.riesgo
                }))
                .sort((a, b) => b.total - a.total);

            if (!items.length) {
                alert("No hay registros para el curso seleccionado.");
                return;
            }

            const totalAtrasos = items.reduce((acc, r) => acc + Number(r.total), 0);
            const alumnos = items.length;
            const promPorAlumno = (totalAtrasos / alumnos).toFixed(2);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "A4" });

            const ahora = new Date();
            const fechaStr = ahora.toLocaleDateString() + " " + ahora.toLocaleTimeString();
            doc.setFontSize(14); doc.text("CEIA ‚Äì Reporte de Atrasos por Curso", 40, 40);
            doc.setFontSize(11); doc.text(`Curso: ${curso}`, 40, 60); doc.text(`Generado: ${fechaStr}`, 40, 78);
            doc.setFontSize(10);
            doc.text(`Alumnos: ${alumnos}`, 40, 100);
            doc.text(`Total de atrasos: ${totalAtrasos}`, 160, 100);
            doc.text(`Promedio de atrasos por alumno: ${promPorAlumno}`, 320, 100);

            const head = [["Estudiante", "Total", "Prom. (min)", "√öltimo atraso", "Riesgo"]];
            const body = items.map(r => [r.nombre, String(r.total), String(r.prom), r.ultimo, r.riesgo]);

            doc.autoTable({
                startY: 120,
                head, body,
                styles: { fontSize: 9, cellPadding: 6 },
                headStyles: { fillColor: [33, 37, 41], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                columnStyles: {
                    0: { cellWidth: 240 }, 1: { cellWidth: 60, halign: "right" },
                    2: { cellWidth: 90, halign: "right" }, 3: { cellWidth: 110, halign: "center" },
                    4: { cellWidth: 80, halign: "center" }
                },
                didDrawPage: function () {
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height || pageSize.getHeight();
                    const pageWidth = pageSize.width || pageSize.getWidth();
                    doc.setFontSize(9); doc.setTextColor(120);
                    doc.text(`App creada por Juan P. Ramirez exporto en IA`, 40, pageHeight - 24);
                    const str = `P√°gina ${doc.internal.getNumberOfPages()}`;
                    const textWidth = doc.getTextWidth(str);
                    doc.text(str, pageWidth - 40 - textWidth, pageHeight - 24);
                }
            });

            const nombreArchivo = `reporte_${curso.replace(/[^a-zA-Z0-9-_]+/g, "_")}.pdf`;
            doc.save(nombreArchivo);
        }

        // PDF de TODOS los cursos (uno por p√°gina)
        function descargarPDFTodos() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "A4" });
            const ahora = new Date();
            const fechaStr = ahora.toLocaleDateString() + " " + ahora.toLocaleTimeString();

            let primeraPagina = true;

            CURSOS_FINALES.forEach(curso => {
                const items = Object.entries(dashboardData.stats_estudiantes || {})
                    .filter(([_, v]) => v.curso === curso)
                    .map(([nombre, v]) => ({
                        nombre,
                        total: v.total_atrasos,
                        prom: Number(v.promedio_minutos || 0).toFixed(1),
                        ultimo: v.ultimo_atraso ? new Date(v.ultimo_atraso).toLocaleDateString() : "",
                        riesgo: v.riesgo
                    }))
                    .sort((a, b) => b.total - a.total);

                if (!items.length) return; // omite cursos sin alumnos

                if (!primeraPagina) doc.addPage();
                primeraPagina = false;

                const totalAtrasos = items.reduce((acc, r) => acc + Number(r.total), 0);
                const alumnos = items.length;
                const promPorAlumno = (totalAtrasos / alumnos).toFixed(2);

                doc.setFontSize(14); doc.text("CEIA ‚Äì Reporte de Atrasos por Curso", 40, 40);
                doc.setFontSize(11); doc.text(`Curso: ${curso}`, 40, 60); doc.text(`Generado: ${fechaStr}`, 40, 78);
                doc.setFontSize(10);
                doc.text(`Alumnos: ${alumnos}`, 40, 100);
                doc.text(`Total de atrasos: ${totalAtrasos}`, 160, 100);
                doc.text(`Promedio de atrasos por alumno: ${promPorAlumno}`, 320, 100);

                const head = [["Estudiante", "Total", "Prom. (min)", "√öltimo atraso", "Riesgo"]];
                const body = items.map(r => [r.nombre, String(r.total), String(r.prom), r.ultimo, r.riesgo]);

                doc.autoTable({
                    startY: 120,
                    head, body,
                    styles: { fontSize: 9, cellPadding: 6 },
                    headStyles: { fillColor: [33, 37, 41], textColor: 255 },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    columnStyles: {
                        0: { cellWidth: 240 }, 1: { cellWidth: 60, halign: "right" },
                        2: { cellWidth: 90, halign: "right" }, 3: { cellWidth: 110, halign: "center" },
                        4: { cellWidth: 80, halign: "center" }
                    },
                    didDrawPage: function () {
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.height || pageSize.getHeight();
                        const pageWidth = pageSize.width || pageSize.getWidth();
                        doc.setFontSize(9); doc.setTextColor(120);
                        doc.text(`App creada por Juan P. Ramirez exporto en IA`, 40, pageHeight - 24);
                        const str = `P√°gina ${doc.internal.getNumberOfPages()}`;
                        const textWidth = doc.getTextWidth(str);
                        doc.text(str, pageWidth - 40 - textWidth, pageHeight - 24);
                    }
                });
            });

            doc.save("reporte_todos_los_cursos.pdf");
        }

        // CSV filtrado (seg√∫n b√∫squeda/curso/riesgo actuales)
        function descargarCSVFiltrado() {
            const q = document.getElementById("q").value.toLowerCase();
            const fc = document.getElementById("f-curso").value;
            const fr = document.getElementById("f-riesgo").value;

            let entries = Object.entries(dashboardData.stats_estudiantes || {});
            if (q) entries = entries.filter(([nom, _]) => nom.toLowerCase().includes(q));
            if (fc) entries = entries.filter(([_, v]) => v.curso === fc);
            if (fr) entries = entries.filter(([_, v]) => v.riesgo === fr);

            const rows = [["Estudiante", "Curso", "Total", "Promedio (min)", "√öltimo atraso", "Riesgo"]];
            entries.forEach(([nom, v]) => {
                rows.push([
                    nom,
                    v.curso,
                    v.total_atrasos,
                    Number(v.promedio_minutos).toFixed(1),
                    v.ultimo_atraso ? new Date(v.ultimo_atraso).toLocaleDateString() : "",
                    v.riesgo
                ]);
            });

            const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(",")).join("\n");
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "reporte_filtrado.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>