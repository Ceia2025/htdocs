<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Finanzas</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header>
      <a href="index.html" class="back-link">‚Üê Volver</a>
      <h2>Finanzas</h2>
    </header>

    <p class="info-text">
      Este m√≥dulo registra los <strong>movimientos de dinero</strong> del sistema.<br>
      Puedes registrar ingresos (dinero que entra) y egresos (dinero que sale).<br>
      Los datos pueden provenir de ventas, pagos, servicios o registros manuales.
    </p>

    <div id="status" class="status"></div>

    <form id="form" class="form-card">
      <input type="hidden" id="id">

      <div class="form-group">
        <label>Cuenta</label>
        <input type="text" id="account" placeholder="Ej: Caja chica o Banco Estado" required>
      </div>

      <div class="form-group">
        <label>Tipo</label>
        <select id="type">
          <option value="Ingreso">Ingreso</option>
          <option value="Egreso">Egreso</option>
        </select>
      </div>

      <div class="form-group">
        <label>Monto</label>
        <input type="number" id="amount" min="0" required>
        <small>Escribe el valor del movimiento (ejemplo: 25000).</small>
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <input type="text" id="description" placeholder="Ej: Pago de servicio el√©ctrico" required>
      </div>

      <button type="submit" class="btn">Guardar</button>
    </form>

    <hr class="divider">

    <h3 class="section-title">Movimientos registrados</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Cuenta</th>
            <th>Tipo</th>
            <th>Monto</th>
            <th>Descripci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <hr class="divider">

    <h3 class="section-title">Resumen actual</h3>
    <p id="summary" class="summary-text">Cargando...</p>
  </div>

  <script>
    const statusDiv = document.getElementById("status");
    const summary   = document.getElementById("summary");

    function showMessage(msg, ok = true) {
      statusDiv.textContent = msg;
      statusDiv.style.color = ok ? "green" : "red";
    }

    async function render() {
      const movimientos = await window.api.listAll("finance");
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      let totalIngresos = 0;
      let totalEgresos  = 0;

      movimientos.forEach((m, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${m.account}</td>
          <td>${m.type}</td>
          <td>${m.amount}</td>
          <td>${m.description}</td>`;
        tbody.appendChild(tr);

        if (m.type === "Ingreso") totalIngresos += m.amount;
        else if (m.type === "Egreso") totalEgresos += m.amount;
      });

      const balance = totalIngresos - totalEgresos;
      summary.textContent = `üíµ Ingresos: $${totalIngresos.toLocaleString()} | üí∏ Egresos: $${totalEgresos.toLocaleString()} | üìä Balance: $${balance.toLocaleString()}`;
    }

    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const data = {
        account: document.getElementById("account").value,
        type: document.getElementById("type").value,
        amount: parseFloat(document.getElementById("amount").value),
        description: document.getElementById("description").value
      };
      const res = await window.api.createIn("finance", data);
      showMessage(res.message || "Movimiento registrado correctamente");
      e.target.reset();
      render();
    });

    render();
  </script>
</body>
</html>
