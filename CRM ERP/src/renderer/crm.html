<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>CRM - Oportunidades</title>
</head>

<body>
  <a href="index.html">‚Üê Volver</a>
  <h2>CRM - Oportunidades</h2>

  <div id="status"></div>

  <form id="form">
    <input type="hidden" id="id">

    <label>Cliente:
      <input type="text" id="customer_search" placeholder="Buscar cliente..." list="customer_list">
      <datalist id="customer_list"></datalist>
    </label><br>
    <small>Selecciona el cliente existente al que pertenece esta oportunidad.</small><br><br>

    <label>T√≠tulo:
      <input type="text" id="title" required>
    </label><br>
    <small>Escribe un nombre corto para identificar esta oportunidad (por ejemplo: ‚ÄúVenta de laptop‚Äù).</small><br><br>

    <label>Descripci√≥n:
      <input type="text" id="description">
    </label><br>
    <small>Agrega detalles o notas internas, como tareas pendientes o pr√≥ximos pasos.</small><br><br>

    <label>Estado:
      <select id="stage">
        <option value="nuevo">Nuevo</option>
        <option value="contactado">Contactado</option>
        <option value="en_progreso">En progreso</option>
        <option value="cerrado_ganado">Cerrado (ganado)</option>
        <option value="cerrado_perdido">Cerrado (perdido)</option>
      </select>
    </label><br>
    <small>Selecciona el estado actual de la oportunidad.</small><br><br>

    <button type="submit">Guardar</button>
  </form>


  <hr>
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>T√≠tulo</th>
        <th>Descripci√≥n</th>
        <th>Etapa</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const statusDiv = document.getElementById("status");

    function showMessage(msg, ok = true) {
      statusDiv.textContent = msg;
      statusDiv.style.color = ok ? "green" : "red";
    }

    async function render() {
      const crm = await window.api.listAll("crm");
      const customers = await window.api.listAll("customers");
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      crm.forEach(item => {
        const c = customers.find(x => x.id === parseInt(item.customer_id));
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${c ? c.name : "(Cliente " + item.customer_id + ")"}</td>
          <td>${item.title}</td>
          <td>${item.description || ""}</td>
          <td>${item.stage}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const data = {
        customer_id: parseInt(document.getElementById("customer_id").value),
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        stage: document.getElementById("stage").value
      };
      await window.api.createIn("crm", data);
      showMessage("Oportunidad guardada correctamente");
      e.target.reset();
      render();
    });

    // üîç Autocompletar clientes
    async function loadCustomerList() {
      const customers = await window.api.listAll('customers');
      const datalist = document.getElementById('customer_list');
      datalist.innerHTML = '';
      customers.forEach(c => {
        const option = document.createElement('option');
        option.value = `${c.name} (ID: ${c.id})`;
        datalist.appendChild(option);
      });
    }

    document.getElementById('customer_search').addEventListener('change', async (e) => {
      const customers = await window.api.listAll('customers');
      const selected = customers.find(c => e.target.value.includes(`ID: ${c.id}`));
      if (selected) {
        document.getElementById('customer_id').value = selected.id;
      } else {
        document.getElementById('customer_id').value = '';
      }
    });

    // üîÅ Cargar datos iniciales
    loadCustomerList();

    render();
  </script>
</body>

</html>